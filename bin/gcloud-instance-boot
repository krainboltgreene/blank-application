#!/bin/sh
set -ex

export HOME=/opt/application/

mkdir -p eve/
mkdir -p tmp/
mkdir -p mnesia/data/
mkdir -p ${HOME}

cd ${HOME}

echo "[STARTUP] Installing packages..."
apt-get install -y \
    apt-transport-https \
    ca-certificates \
    wget \
    curl \
    gnupg-agent \
    software-properties-common &&

echo "[STARTUP] Fetching docker gpg key..."
curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add - &&

echo "[STARTUP] Adding apt repository for docker..."
add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/debian \
   $(lsb_release -cs) \
   stable" &&

echo "[STARTUP] Updating apt index..."
apt update &&

echo "[STARTUP] Installing docker..."
apt-get install -y \
    docker-ce docker-ce-cli containerd.io &&

echo "[STARTUP] Giving permission to docker..."
usermod -a -G docker krainboltgreene &&

echo "[STARTUP] Authenticating with gcloud docker..."
yes | gcloud auth configure-docker &&

echo "[STARTUP] Pulling docker images..."
docker pull redis:6.0.6 &&

echo "[STARTUP] Downloading CloudSQL Proxy..."
wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 \
    -O cloud_sql_proxy &&
chmod +x cloud_sql_proxy &&
mkdir /cloudsql &&
PROJECT_ID=$(curl \
    -s "http://metadata.google.internal/computeMetadata/v1/project/project-id" \
    -H "Metadata-Flavor: Google")
./cloud_sql_proxy -projects=${PROJECT_ID} -dir=/cloudsql &

echo "[STARTUP] Starting redis..."
docker run --rm --detach --publish 127.0.0.1:6379:6379 --name redis redis:6.0.6

echo "[STARTUP] Downloading latest release..."
RELEASE_URL=$(curl \
    -s "http://metadata.google.internal/computeMetadata/v1/instance/attributes/release-url" \
    -H "Metadata-Flavor: Google")
gsutil cp ${RELEASE_URL} affinity_matrix.run
chmod +x affinity_matrix.run
./affinity_matrix.run start
./affinity_matrix.run cli setup
